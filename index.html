<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è»Šå®¹åŠçŒœæ­Œç‹ - 700äººä½µç™¼æ¶ç­”æ¸¬è©¦</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .log-box { height: 250px; overflow-y: auto; font-family: monospace; background: #0f172a; color: #10b981; border: 1px solid #1e293b; }
        .data-preview { height: 120px; overflow-y: auto; font-family: monospace; background: #1e293b; color: #f1f5f9; }
        .input-label { @apply block text-xs font-bold text-slate-500 uppercase mb-1; }
        .input-field { @apply w-full p-2 border rounded mb-3 bg-white focus:ring-2 focus:ring-teal-400 outline-none text-sm; }
        .btn-action { @apply flex-1 font-black py-4 rounded-2xl transition shadow-xl active:scale-95 transform disabled:opacity-50 text-white; }
        .burst-badge { @apply bg-red-500 text-white text-[10px] px-2 py-0.5 rounded ml-2 animate-pulse; }
    </style>
</head>
<body class="bg-slate-50 p-4 md:p-8 font-sans">
    <div class="max-w-5xl mx-auto bg-white rounded-3xl shadow-2xl overflow-hidden border border-slate-200">
        
        <div class="bg-slate-900 p-6 text-white border-b border-slate-700">
            <div class="flex justify-between items-center">
                <div>
                    <h1 class="text-2xl font-black flex items-center tracking-tight">
                        <span class="mr-3 text-teal-400">ğŸ¤</span> ä½µç™¼è¡çªæ¸¬è©¦ <span class="burst-badge">æ¥µé™ç­”é¡Œæ¨¡å¼</span>
                    </h1>
                    <p class="text-slate-400 text-xs mt-1">å°ˆé–€æ¨¡æ“¬ã€ŒåŒç§’æ•¸ã€æ¶ç­”è¡Œç‚ºï¼Œæ¸¬è©¦å¤§è¢å¹•æ’åºç©©å®šæ€§</p>
                </div>
                <div id="authStatus" class="px-3 py-1 rounded-full bg-slate-700 text-[10px] font-bold text-slate-300">é€£ç·šä¸­...</div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3">
            <!-- å·¦å´è¨­å®š -->
            <div class="p-6 border-r border-slate-100 bg-slate-50/50">
                <h2 class="font-bold text-slate-700 mb-4 text-sm flex items-center">
                    <span class="w-1.5 h-4 bg-teal-500 rounded mr-2"></span>è¡çªè¨­å®š
                </h2>
                
                <div class="p-4 bg-indigo-900 rounded-2xl text-white mb-6">
                    <p class="text-[10px] opacity-60 uppercase font-bold">åŒæ­¥å¤§è¢å¹•é—œå¡</p>
                    <h3 id="activeSongId" class="text-3xl font-black text-cyan-400">è¼‰å…¥ä¸­...</h3>
                </div>

                <label class="input-label">æ¨¡æ“¬ç©å®¶ç¸½æ•¸</label>
                <input id="playerCount" type="number" value="700" class="input-field text-lg font-bold">

                <label class="input-label">åŒç§’ä½µç™¼äººæ•¸</label>
                <input id="burstSize" type="number" value="50" class="input-field">
                <p class="text-[10px] text-gray-400 mb-4">é€™æœƒå¼·è¿«é€™ 50 äººåœ¨åŒä¸€æ¯«ç§’é€å‡ºç­”æ¡ˆï¼Œæ¸¬è©¦å¤§è¢å¹•æ˜¯å¦æœƒè·³å‹•ã€‚</p>

                <button id="cleanupBtn" class="w-full bg-red-100 text-red-600 py-2 rounded-xl text-xs font-bold hover:bg-red-600 hover:text-white transition">
                    ğŸ§¹ æ¸…ç†æ¸¬è©¦æ•¸æ“š
                </button>
            </div>

            <!-- å³å´åŸ·è¡Œ -->
            <div class="p-6 lg:col-span-2">
                <h2 class="font-bold text-slate-700 mb-4 text-sm flex items-center">
                    <span class="w-1.5 h-4 bg-blue-500 rounded mr-2"></span>åŸ·è¡Œæ¸¬è©¦
                </h2>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-8">
                    <button id="readyBtn" class="btn-action bg-blue-600 hover:bg-blue-700">
                        1. å…¨å“¡å°±ç·’ (Players)
                    </button>
                    <button id="burstGuessBtn" class="btn-action bg-red-600 hover:bg-red-700 disabled:bg-gray-300" disabled>
                        2. ç™¼å‹•æ¥µé™ä½µç™¼æ¶ç­” (Guesses)
                    </button>
                </div>

                <div class="space-y-4">
                    <div class="flex justify-between items-end">
                        <h3 class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">è¨ºæ–·æ—¥èªŒ</h3>
                        <span id="writeStat" class="text-[10px] text-teal-600 font-bold">å¯«å…¥: 0</span>
                    </div>
                    <div id="log" class="log-box p-4 rounded-2xl text-[10px]"></div>
                    <h3 class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">æ•¸æ“šçµæ§‹é è¦½</h3>
                    <div id="dataPreview" class="data-preview p-4 rounded-2xl text-[10px]">ç­‰å¾…æ“ä½œ...</div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection, getDocs, deleteDoc, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyD7C07fbk2MGnZNARdRICjxep9GVpMooTQ",
            authDomain: "oilgroup-7f510.firebaseapp.com",
            projectId: "oilgroup-7f510",
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = "oilgroup-music-game";

        let currentActiveSongId = null;
        let successCount = 0;

        const log = (msg, type = 'info') => {
            const logEl = document.getElementById('log');
            const colors = { error: 'text-red-400', success: 'text-teal-400', info: 'text-slate-400', warn: 'text-orange-400' };
            logEl.innerHTML += `<div class="${colors[type]} mb-1">[${new Date().toLocaleTimeString()}] ${msg}</div>`;
            logEl.scrollTop = logEl.scrollHeight;
        };

        window.onload = async () => {
            await signInAnonymously(auth);
            document.getElementById('authStatus').innerText = "âœ… é©—è­‰æˆåŠŸ";
            document.getElementById('authStatus').classList.replace('bg-slate-700', 'bg-teal-500');

            onSnapshot(doc(db, 'artifacts', appId, 'public', 'data', 'game_state', 'current'), (snap) => {
                if (snap.exists()) {
                    currentActiveSongId = snap.data().activeSongId;
                    document.getElementById('activeSongId').innerText = `ç¬¬ ${currentActiveSongId} é—œ`;
                    document.getElementById('burstGuessBtn').disabled = !currentActiveSongId;
                }
            });
        };

        // 1. å…¨å“¡å°±ç·’
        document.getElementById('readyBtn').addEventListener('click', async () => {
            const count = parseInt(document.getElementById('playerCount').value);
            log(`ğŸš€ æ­£åœ¨å°±ç·’ ${count} åç©å®¶...`);
            for (let i = 0; i < count; i++) {
                const pid = `STRESS_BOT_${i}`;
                setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'players', pid), {
                    userName: `æ©Ÿå™¨äºº_${i}`,
                    empId: `BOT${i}`,
                    userType: i % 2 === 0 ? 'employee' : 'family',
                    timestamp: Date.now()
                }).then(() => {
                    successCount++;
                    document.getElementById('writeStat').innerText = `å¯«å…¥: ${successCount}`;
                });
                if (i % 100 === 0) await new Promise(r => setTimeout(r, 100));
            }
            log(`âœ… ${count} äººå°±ç·’å®Œæˆ`, "success");
        });

        // 2. æ¥µé™ä½µç™¼æ¶ç­” (è£½é€ åŒç§’æ•¸è¡çª)
        document.getElementById('burstGuessBtn').addEventListener('click', async () => {
            const count = parseInt(document.getElementById('playerCount').value);
            const burstSize = parseInt(document.getElementById('burstSize').value);
            const now = Date.now(); // æŠ“å–åŒä¸€å€‹æ™‚é–“æˆ³

            log(`ğŸ”¥ ç™¼å‹•ä½µç™¼æ”»æ“Šï¼æ¯ ${burstSize} äººä½¿ç”¨å®Œå…¨ç›¸åŒçš„ timestamp...`, "warn");

            for (let i = 0; i < count; i++) {
                const pid = `STRESS_BOT_${i}`;
                const gRef = doc(db, 'artifacts', appId, 'public', 'data', 'guesses', pid);
                
                // æ¨¡æ“¬ä½µç™¼ï¼šæ¯éš” burstSize å€‹äººæ‰åˆ‡æ›ä¸€æ¬¡æ™‚é–“æˆ³
                const sharedTimestamp = now + (Math.floor(i / burstSize) * 1000); 

                setDoc(gRef, {
                    songId: currentActiveSongId,
                    userName: `æ©Ÿå™¨äºº_${i}`,
                    empId: `BOT${i}`,
                    userType: i % 2 === 0 ? 'employee' : 'family',
                    isCorrect: true,
                    timestamp: sharedTimestamp,
                    responseTime: (i * 0.001) + 0.5 // åæ‡‰æ™‚é–“ç¶­æŒå¾®å°å·®ç•°
                }).then(() => {
                    successCount++;
                    document.getElementById('writeStat').innerText = `å¯«å…¥: ${successCount}`;
                });

                if (i === 0) {
                    onSnapshot(gRef, (snap) => {
                        document.getElementById('dataPreview').innerText = "è¡çªåŒ…é è¦½ï¼š\n" + JSON.stringify(snap.data(), null, 2);
                    });
                }

                // ç‚ºäº†é”åˆ°ä½µç™¼æ•ˆæœï¼Œæ¸›å°‘ç­‰å¾…æ™‚é–“
                if (i % 100 === 0) await new Promise(r => setTimeout(r, 10));
            }
            log(`ğŸ† å·²é€å‡º 700 äººç­”æ¡ˆã€‚å…¶ä¸­æ¯ ${burstSize} äººçš„æ™‚é–“æˆ³æ˜¯å®Œå…¨ä¸€æ¨£çš„ã€‚`, "success");
        });

        document.getElementById('cleanupBtn').addEventListener('click', async () => {
            log("ğŸ§¹ æ¸…ç†ä¸­...");
            const paths = ['players', 'guesses'];
            for (const p of paths) {
                const snap = await getDocs(collection(db, 'artifacts', appId, 'public', 'data', p));
                const batch = snap.docs.filter(d => d.id.startsWith('STRESS_BOT_'));
                for (const d of batch) { await deleteDoc(d.ref); }
            }
            successCount = 0;
            document.getElementById('writeStat').innerText = `å¯«å…¥: 0`;
            log("âœ… æ¸…ç†å®Œæˆ", "success");
        });
    </script>
</body>
</html>
